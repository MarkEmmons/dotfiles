#!/bin/bash

install_dotfiles(){

	# Install Pathogen
	mkdir -p $HOME/.vim/autoload $HOME/.vim/bundle && \
	curl -LSso $HOME/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim

	# Vim Plugins
	PLUGINS=( scrooloose/syntastic
	scrooloose/nerdtree
	majutsushi/tagbar
	airblade/vim-gitgutter
	ntpeters/vim-better-whitespace )

	# Install plugins via parallel trickery
	cd $HOME/.vim/bundle && \
	printf "%s\n" "${PLUGINS[@]}" | parallel "git clone https://github.com/{}.git"
	cd

	# Install ohmyzsh
	curl -LJO https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
	if [[ "$(cat install.sh | sha256sum)" = "d5e0d3503e2edeac166113bc3f577512308200e986bc7e727762d98b1aee647c  -" ]]; then
		sh install.sh
	fi

	rm -f .zshrc
	rm -f install.sh
	rm .zshrc.pre-oh-my-zsh

	# Stow dotfiles
	cd $HOME/dotfiles/
	stow .config
	#stow compton
	stow tmux
	stow vim
	stow x
	stow zsh
	cd

}

# Update Vim plugins
update_dotfiles(){

	# Update Pathogen plugins
	for i in $HOME/.vim/bundle/*; do git -C $i pull; done

}

# Do not run this script as root
if [[ $EUID -eq 0 ]]; then
	echo "error: this script should not be run as root."
	exit 1
fi

# User must provide exactly one argument
if [[ $# -ne 1 ]]; then
	echo "error: expected exactly 1 argument got $#."
	exit 1
fi

# Update or install
case $1 in
	-i|--install)
		echo "Installing dotfiles..."
		install_dotfiles
		;;
	-u|--update)
		echo "Updating dotfiles..."
		update_dotfiles
		;;
	*)
		echo "ERROR: Unknown argument $1."
		exit 1
		;;
esac
