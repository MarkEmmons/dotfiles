#!/bin/bash

install_dotfiles(){

	# Install Pathogen
	mkdir -p $HOME/.vim/autoload $HOME/.vim/bundle && \
	curl -LSso $HOME/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim

	# Vim Plugins
	PLUGINS=(
		vim-syntastic/syntastic
		preservim/nerdtree
		majutsushi/tagbar
		airblade/vim-gitgutter
		ntpeters/vim-better-whitespace
		rust-lang/rust.vim
		lervag/vimtex
	)

	# Install plugins via parallel trickery
	cd $HOME/.vim/bundle && \
	printf "%s\n" "${PLUGINS[@]}" | parallel "git clone --depth=1 https://github.com/{}.git"
	cd

	# Install ohmyzsh
	curl -LJO https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
	if [[ "$(cat install.sh | sha256sum)" = "d5e0d3503e2edeac166113bc3f577512308200e986bc7e727762d98b1aee647c  -" ]]; then
		sh install.sh
	fi

	[[ -f .zshrc ]] && rm -f .zshrc
	[[ -f install.sh ]] && rm -f install.sh
	[[ -f .zshrc.pre-oh-my-zsh ]] && rm -f .zshrc.pre-oh-my-zsh

	# Stow dotfiles
	cd $HOME/workspace/dotfiles/
	stow alacritty --target=$HOME
	stow bspwm --target=$HOME
	stow feh --target=$HOME
	stow luakit --target=$HOME
	stow picom --target=$HOME
	stow sxhkd --target=$HOME
	stow tmux --target=$HOME
	stow vim --target=$HOME
	stow x --target=$HOME
	stow zathura --target=$HOME
	stow zsh --target=$HOME
	cd

}

# Update Vim plugins
update_dotfiles(){

	# Pull latest dotfiles
	git -C $HOME/workspace/dotfiles pull

	# Update Pathogen plugins
	for i in $HOME/.vim/bundle/*; do git -C $i pull; done

}

# Do not run this script as root
if [[ $EUID -eq 0 ]]; then
	echo "error: this script should not be run as root."
	exit 1
fi

# User must provide exactly one argument
if [[ $# -ne 1 ]]; then
	echo "error: expected exactly 1 argument got $#."
	exit 1
fi

# Update or install
case $1 in
	-i|--install)
		echo "Installing dotfiles..."
		install_dotfiles
		;;
	-u|--update)
		echo "Updating dotfiles..."
		update_dotfiles
		;;
	*)
		echo "ERROR: Unknown argument $1."
		exit 1
		;;
esac
